---
import { getCollection } from "astro:content";

type ImageItem = {
  id: string;
  src: string;
  alt?: string;
};

interface Props {
  basePath?: string; // es: "/progetti"
}

const { basePath = "/progetti" } = Astro.props as Props;

// prende solo i post con heroImage (URL o path)
const posts = await getCollection("posts", ({ data }) => !!data.heroImage);

// sort robusto: pubDate puÃ² essere Date o stringa
const toTime = (d: unknown) => {
  if (d instanceof Date) return d.getTime();
  if (typeof d === "string") return new Date(d).getTime();
  return 0;
};

posts.sort((a, b) => toTime(b.data.pubDate) - toTime(a.data.pubDate));

const images: ImageItem[] = posts.map((post) => ({
  id: post.slug,
  src: post.data.heroImage as string,
  alt: post.data.title as string,
}));

const getItemClasses = (index: number) => {
  if (index % 7 === 0) return "md:col-span-2 md:row-span-2";
  if (index % 7 === 3) return "md:col-span-2";
  if (index % 7 === 5) return "md:row-span-2";
  return "";
};
---

<section class="w-full bg-white">
  <div class="max-w-5xl mx-auto px-4 py-10">
    <div class="grid gap-4 grid-cols-2 md:grid-cols-4 auto-rows-[140px] md:auto-rows-[180px]">
      {
        images.map((image, index) => (
          <a
            href={`${basePath}/${encodeURIComponent(image.id)}`}
            class:list={[
              "group relative block h-full w-full overflow-hidden rounded-md bg-slate-100 animate-fade-down",
              getItemClasses(index),
            ].filter(Boolean)}
            style={`animation-delay: ${(index + 1) * 300}ms;`}
          >
            <figure class="h-full w-full">
              <img
                src={image.src}
                alt={image.alt || ""}
                loading="lazy"
                class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-[1.03]"
              />
            </figure>

            <span class="pointer-events-none absolute inset-0 border border-transparent group-hover:border-slate-300/70 transition-colors duration-300"></span>
          </a>
        ))
      }
    </div>
  </div>
</section>
